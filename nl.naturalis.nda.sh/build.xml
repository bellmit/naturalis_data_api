<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:if="ant:if" xmlns:unless="ant:unless" basedir="." name="nl.naturalis.nda.sh" default="build">

	<import file="../nl.naturalis.nda.build/properties.xml" />
	<import file="../nl.naturalis.nda.build/common.xml" />
	<property file="../nl.naturalis.nda.build/build.properties" />
	<property environment="env" />

	<target name="clean-import">
		<delete includeemptydirs="true">
			<fileset dir="${nda.import.install.dir}" includes="**/*" />
		</delete>
	</target>

	<target name="clean-export">
		<available file="${nda.export.install.dir}" type="dir" property="export.module.installed" />
		<echo unless:set="export.module.installed" message="Installation directory does not exist: ${nda.export.install.dir} (nothing to clean)" />
		<echo if:set="export.module.installed" message="Deleting shell scripts (${nda.export.install.dir}/sh)" />
		<delete if:set="export.module.installed" dir="${nda.export.install.dir}/sh" />
		<echo if:set="export.module.installed" message="Deleting configuration files (${nda.export.install.dir}/conf)" />
		<delete if:set="export.module.installed" dir="${nda.export.install.dir}/conf" />
		<echo if:set="export.module.installed" message="Deleting Java libraries (${nda.export.install.dir}/lib)" />
		<delete if:set="export.module.installed" dir="${nda.export.install.dir}/lib" />
	</target>

	<!--
		Re-installs the shell scripts and configuration files using
		the latest version of build.properties, but does not build or
		rebuild the load project.
	-->
	<target name="patch-import">
		<!--
			Check if the installation directory is present; otherwise
			there's nothing to patch
		-->
		<available file="${nda.import.install.dir}" type="dir" property="sh.module.installed" />
		<fail unless:set="sh.module.installed" message="Missing directory ${nda.import.install.dir}. Please run &#034;ant install-import&#034; first" />
		<echo message="Installing configuration files into ${nda.import.install.dir}/conf" />
		<copy todir="${nda.import.install.dir}/conf" overwrite="true">
			<fileset dir="import/conf" excludes="**/*.git*" />
			<filterset begintoken="@" endtoken="@" filtersfile="${build.module.location}/build.properties" />
		</copy>
		<echo message="Installing shell scripts into ${nda.import.install.dir}/sh" />
		<copy todir="${nda.import.install.dir}/sh" overwrite="true">
			<fileset dir="import/sh" excludes="**/*.git*" />
			<filterset begintoken="@" endtoken="@" filtersfile="${build.module.location}/build.properties" />
		</copy>
	</target>

	<target name="install-import">
		<mkdir dir="${nda.import.install.dir}" />
		<antcall target="patch-import" />
		<echo message="Installing libraries into ${nda.import.install.dir}/lib" />
		<mkdir dir="${nda.import.install.dir}/lib" />
		<copy file="${domain.module.location}/build/${domain.module.artifact}" todir="${nda.import.install.dir}/lib" />
		<copy todir="${nda.import.install.dir}/lib">
			<fileset dir="${domain.module.location}/build/classpath" />
		</copy>
		<copy file="${dao.module.location}/build/${dao.module.artifact}" todir="${nda.import.install.dir}/lib" />
		<copy todir="${nda.import.install.dir}/lib">
			<fileset dir="${dao.module.location}/build/classpath" />
		</copy>
		<copy file="${load.module.location}/build/${load.module.artifact}" todir="${nda.import.install.dir}/lib" />
		<copy todir="${nda.import.install.dir}/lib">
			<fileset dir="${load.module.location}/build/classpath" />
		</copy>
	</target>

	<!--
		Copy the conf and sh directory into the installation directory
		for the export module while replacing any ant tokens with
		actual values from build.properties
	-->
	<target name="patch-export">
		<available file="${nda.export.install.dir}" type="dir" property="export.module.installed" />
		<fail unless:set="export.module.installed" message="Missing directory ${nda.export.install.dir}. Please run &#034;ant install-import&#034; first" />
		<echo message="Installing configuration files into ${nda.export.install.dir}/conf" />
		<copy todir="${nda.export.install.dir}/conf" overwrite="true">
			<fileset dir="export/conf" excludes="**/*.git*" />
			<filterset begintoken="@" endtoken="@" filtersfile="${build.module.location}/build.properties" />
		</copy>
		<echo message="Installing shell scripts into ${nda.export.install.dir}/sh" />
		<copy todir="${nda.export.install.dir}/sh" overwrite="true">
			<fileset dir="export/sh" excludes="**/*.git*" />
			<filterset begintoken="@" endtoken="@" filtersfile="${build.module.location}/build.properties" />
		</copy>
	</target>

	<target name="install-export">
		<!-- Create installation directory if it does not exist yet -->
		<mkdir dir="${nda.export.install.dir}" />
		<!-- Copy shell scripts and config files to installation directory -->
		<antcall target="patch-export" />
		<!-- Copy libraries to installation directory -->
		<property name="libdir" value="${nda.export.install.dir}/lib" />
		<echo message="Installing libraries into ${libdir}" />
		<mkdir dir="${libdir}" />
		<!-- Copy domain module jar and its dependencies to lib dir -->
		<copy file="${domain.module.location}/build/${domain.module.artifact}" todir="${libdir}" />
		<copy todir="${libdir}">
			<fileset dir="${domain.module.location}/build/classpath" />
		</copy>
		<!-- Copy dao module jar and its dependencies to lib dir -->
		<copy file="${dao.module.location}/build/${dao.module.artifact}" todir="${libdir}" />
		<copy todir="${libdir}">
			<fileset dir="${dao.module.location}/build/classpath" />
		</copy>
		<!-- Copy export module jar and its dependencies to lib dir -->
		<copy file="${export.module.location}/build/${export.module.artifact}" todir="${libdir}" />
		<copy todir="${libdir}">
			<fileset dir="${export.module.location}/build/classpath" />
		</copy>
		<!-- Make shell scripts executable -->
		<chmod dir="${nda.export.install.dir}/sh" perm="ugo+rx" includes="**/*.sh" />
	</target>

	<target name="build">
		<echo message="Please be more specific" />
	</target>

</project>