<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:if="ant:if" xmlns:unless="ant:unless" basedir="." name="nl.naturalis.nda.build" default="help">

	<tstamp>
		<format property="now" pattern="yyyy_MM_dd___HH_mm_ss" locale="en" />
	</tstamp>

	<target name="verify" description="Verify preconditions for doing NBA builds with Ant">
		<!-- Make sure ivy-x.x.x.jar has been copied over to ant -->
		<fail message="ivy-x.x.x.jar not found in ${ant.library.dir}. Please copy jar file from your Ivy installation directory.">
			<condition>
				<not>
					<resourcecount count="1">
						<fileset dir="${ant.library.dir}" includes="ivy-*.jar" />
					</resourcecount>
				</not>
			</condition>
		</fail>
		<!-- Check Git -->
		<exec executable="git" outputproperty="git.ok" failifexecutionfails="false">
			<arg value="branch" />
		</exec>
		<!-- Make sure build.properties.tpl has been copied to build.properties -->
		<fail message="Copy build.properties.tpl to build.properties and make sure it contains the correct settings">
			<condition>
				<not>
					<resourcecount count="1">
						<fileset dir="${basedir}" includes="build.properties" />
					</resourcecount>
				</not>
			</condition>
		</fail>
		<fail unless:set="git.ok" message="Git not installed, or Git bin directory not added to PATH yet" />
		<!-- We got clearance! -->
		<property name="signal.clear" value="on" />
		<echo message="Seems like you're good to go!" />
	</target>

	<target name="help" description="Show help text">
		<echo message="Show all build options                            : ant -p" />
		<echo message="Build all modules                                 : ant build" />
		<echo message="Clean all modules and then rebuild                : ant rebuild | pristine build" />
		<echo message="Build ear file                                    : ant ear" />
		<echo message="Rebuild ear module                                : ant clean ear" />
		<echo message="Rebuild ear module and referenced modules         : ant pristine ear" />
		<echo message="Build module(s)                                   : ant &lt;module-name&gt; [&lt;module-name&gt; ...]" />
		<echo message="Valid module names: domain, dao, ejb, rest, ear, load, export, sh" />
		<echo message="Rebuild module(s)                                 : ant clean &lt;module-name&gt; [&lt;module-name&gt; ...]" />
		<echo message="Rebuild module(s) and referenced modules          : ant pristine &lt;module-name&gt; [&lt;module-name&gt; ...]" />
		<echo message="Create/modify Eclipse metadata files              : ant eclipse" />
		<echo message="Delete and create Eclipse metadata files          : ant clean eclipse" />
	</target>

	<target name="git-info" unless:set="git.got.info" description="Show information about the Git branch you will be doing your builds on">
		<exec executable="git" outputproperty="git.revision" failifexecutionfails="true">
			<arg value="log" />
			<arg value='--pretty=format:"%H"' />
			<arg value="-n" />
			<arg value="1" />
		</exec>
		<exec executable="git" outputproperty="git.branch" failifexecutionfails="true">
			<arg value="rev-parse" />
			<arg value="--abbrev-ref" />
			<arg value="HEAD" />
		</exec>
		<exec executable="git" outputproperty="git.status" failifexecutionfails="false">
			<arg value="status" />
			<arg value="-s" />
		</exec>
		<condition property="git.committed">
			<and>
				<equals arg1="${git.status}" arg2="" trim="true" />
				<isset property="git.got.info" />
			</and>
		</condition>
		<echo unless:set="git.got.info" message=" " />
		<echo unless:set="git.got.info" message="****************************************************************" />
		<echo unless:set="git.got.info" message="You are on branch: ${git.branch}" />
		<echo unless:set="git.got.info" message="****************************************************************" />
		<echo unless:set="git.got.info" message=" " />
		<echo unless:set="git.got.info" message="Last commit: ${git.revision}" />
		<echo unless:true="git.committed" message=" " />
		<echo unless:true="git.committed" message="Warning: there are uncommitted changes in ${git.branch}" />
		<!-- Allow some time for a heart attack -->
		<echo unless:set="git.got.info" message="You got 3 seconds before the build continues ..." />
		<sleep unless:set="git.got.info" seconds="3" />
		<property name="git.got.info" value="true" />
	</target>

	<target name="clean" depends="git-info" description="Force a clean build of the subsequently specified module">
		<property name="signal.clean" value="on" />
	</target>

	<target name="pristine" depends="git-info" description="Force a clean build of the subsequently specified module and all modules it depends on">
		<property name="signal.pristine" value="on" />
	</target>

	<target name="domain" description="Build domain module">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="dao" description="Build dao module">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="ejb" depends="git-info" description="Build ejb module">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="rest" description="Build rest module">
		<antcall target="verify" unless:set="signal.clear" description="build rest module" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="ear" description="Build ear module (will create the NBA ear file)">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="load" description="Build load module (import programs)">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="export" description="Build export module">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.export/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.export/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.export/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="sh" description="Install Unix shell script wrappers for the import and export programs">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.sh/build.xml" useNativeBasedir="true" inheritrefs="true" target="install-import" />
	</target>

	<target name="build" depends="ear,load,export" description="Build ear file, import programs and export programs" />

	<target name="rebuild" depends="pristine,ear,load,export" description="Build ear file, import programs and export programs from scratch" />

	<target name="eclipse" description="Create/adjust Eclipse metadata files">
		<antcall target="verify" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="eclipse" />
	</target>


</project>