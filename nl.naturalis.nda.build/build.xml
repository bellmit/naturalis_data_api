<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:if="ant:if" xmlns:unless="ant:unless" basedir="." name="nl.naturalis.nda.build">

	<property file="build.properties" />

	<path id="ivy.lib.path">
		<fileset dir="${ivy.home}" includes="*.jar" />
	</path>
	<taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path" />

	<tstamp>
		<format property="now" pattern="yyyy_MM_dd___HH_mm_ss" locale="en" />
	</tstamp>

	<target name="check">
		<!-- Check Ivy -->
		<available file="${ivy.home}" type="dir" property="check.tmp0" />
		<fail unless:set="check.tmp0" message="Invalid value for property &#34;ivy.home&#34;. Please install Ivy and/or check ${basedir}/build.properties" />
		<!-- Make sure ivy-x.x.x.jar has been copied over to ant -->
		<fail message="ivy-x.x.x.jar not found in ${ant.library.dir}. Please copy jar file from ${ivy.home}">
			<condition>
				<not>
					<resourcecount count="1">
						<fileset dir="${ant.library.dir}" includes="ivy-*.jar" />
					</resourcecount>
				</not>
			</condition>
		</fail>
		<!-- Check Git -->
		<exec executable="git" outputproperty="check.tmp2" failifexecutionfails="false">
			<arg value="--version" />
		</exec>
		<fail unless:set="check.tmp2" message="Git not installed, or Git bin directory not added to PATH yet" />
		<!-- We got clearance! -->
		<property name="signal.clear" value="on" />
	</target>

	<target name="git.info" unless:set="git.got.info">
		<exec executable="git" outputproperty="git.revision" failifexecutionfails="true">
			<arg value="log" />
			<arg value='--pretty=format:"%H"' />
			<arg value="-n" />
			<arg value="1" />
		</exec>
		<exec executable="git" outputproperty="git.branch" failifexecutionfails="true">
			<arg value="rev-parse" />
			<arg value="--abbrev-ref" />
			<arg value="HEAD" />
		</exec>
		<echo unless:set="git.got.info" message=" " />
		<echo unless:set="git.got.info" message="******************************************************************" />
		<echo unless:set="git.got.info" message="* You are on branch: ${git.branch}" />
		<echo unless:set="git.got.info" message="******************************************************************" />
		<echo unless:set="git.got.info" message=" " />
		<echo unless:set="git.got.info" message="Last commit: ${git.revision}" />
		<sleep unless:set="git.got.info" seconds="3"/>
		<property name="git.got.info" value="true" />
	</target>

	<target name="clean" depends="git.info">
		<property name="signal.clean" value="on" />
	</target>

	<target name="pristine" depends="git.info">
		<property name="signal.pristine" value="on" />
	</target>

	<target name="domain">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="dao">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="ejb" depends="git.info">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="rest">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="ear">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ejb/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.service.rest/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="load">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.domain/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.dao/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.pristine" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" target="clean" if:set="signal.clean" />
		<ant antfile="../nl.naturalis.nda.elasticsearch.load/build.xml" useNativeBasedir="true" inheritrefs="true" />
	</target>

	<target name="build" depends="ear,load" />

	<target name="rebuild" depends="pristine,ear,load" />

	<target name="eclipse">
		<antcall target="check" unless:set="signal.clear" />
		<ant antfile="../nl.naturalis.nda.ear/build.xml" useNativeBasedir="true" inheritrefs="true" target="eclipse" />
	</target>


</project>